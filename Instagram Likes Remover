(async function instagramBulkUnlike() {
  window.__STOP_IG_BULK_UNLIKE__ = false;

  const MAX = 80;
  const CYCLE_DELAY = 40000;
  const SELECT_DELAY = 1800;
  const ICON_DELAY = 500;
  const ACTION_DELAY = 1200;
  const MODAL_DELAY = 1200;
  const SCROLL_DELAY = 2000;

  const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

  // Simulate real user click
  function realClick(el) {
    el.scrollIntoView({ block: "center" });
    ["mousedown", "mouseup", "click"].forEach((t) => {
      el.dispatchEvent(
        new MouseEvent(t, {
          bubbles: true,
          cancelable: true,
          buttons: 1
        })
      );
    });
  }

  // Find Select button
  function findSelectButton() {
    return [...document.querySelectorAll(
      'div[data-bloks-name="bk.components.Flexbox"]'
    )].find((el) => el.innerText?.trim() === "Select");
  }

  async function activateSelectMode() {
    const btn = findSelectButton();
    if (!btn) throw new Error("Select button not found");
    realClick(btn);
    await sleep(SELECT_DELAY);
  }

  // Get selectable icons
  function getSelectableIcons() {
    return document.querySelectorAll(
      'div[data-bloks-name="ig.components.Icon"][style*="circle__outline"]'
    );
  }

  async function selectLikes(max) {
    let count = 0;
    let lastCount = 0;

    while (count < max) {
      const icons = getSelectableIcons();

      for (const icon of icons) {
        if (count >= max) break;

        const btn = icon.closest('[role="button"]');
        if (!btn || btn.__clicked) continue;

        btn.__clicked = true;
        realClick(btn);
        count++;
        await sleep(ICON_DELAY);
      }

      if (count === lastCount) {
        window.scrollBy(0, window.innerHeight);
        await sleep(SCROLL_DELAY);

        const newIcons = getSelectableIcons();
        if (newIcons.length === icons.length) break;
      }

      lastCount = count;
    }

    return count;
  }

  // Find Unlike button
  function findUnlikeButton() {
    const span = [...document.querySelectorAll("span")]
      .find((el) => el.innerText?.trim() === "Unlike");
    return span?.closest("button, div");
  }

  async function clickUnlike() {
    await sleep(ACTION_DELAY);
    const btn = findUnlikeButton();
    if (!btn) throw new Error("Unlike action not found");
    realClick(btn);
  }

  // Modal confirm
  function findModalConfirmButton() {
    return [...document.querySelectorAll("button")]
      .find((btn) => btn.innerText?.trim() === "Unlike");
  }

  async function confirmModal() {
    await sleep(MODAL_DELAY);
    const confirmBtn = findModalConfirmButton();
    if (!confirmBtn) throw new Error("Modal confirmation not found");
    confirmBtn.focus();
    await sleep(100);
    confirmBtn.click();
  }

  // üîÅ TAB REFRESH LOGIC

  // üîÅ TAB REFRESH LOGIC (robust ‚Äì uses tab order instead of text)

function getTabs() {
  return [...document.querySelectorAll('[role="tab"]')];
}

async function refreshLikesTab() {
  const tabs = getTabs();

  if (tabs.length < 2) {
    console.warn("Could not find tab bar to refresh");
    return;
  }

  const likesTab = tabs[0];     // first tab = Likes
  const commentsTab = tabs[1];  // second tab = Comments

  // Go to Comments
  realClick(commentsTab);
  await sleep(1500);

  // Back to Likes
  realClick(likesTab);
  await sleep(3000); // wait for reload
}


  let cycle = 1;

  // üîÅ MAIN LOOP
  while (!window.__STOP_IG_BULK_UNLIKE__) {
    try {
      await activateSelectMode();
      const selected = await selectLikes(MAX);

      if (!selected) {
        console.log("‚úÖ No likes remaining. Finished.");
        break;
      }

      await clickUnlike();
      await confirmModal();

      console.log(`üî• Cycle ${cycle}: unliked ${selected}`);

      // Force refresh
      await refreshLikesTab();

      cycle++;
      await sleep(CYCLE_DELAY);

    } catch (e) {
      console.warn("‚õî Stopped:", e.message);
      break;
    }
  }
})();
